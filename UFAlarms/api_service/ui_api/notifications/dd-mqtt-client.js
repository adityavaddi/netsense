/**
 * Created by dejan on 9.2.16..
 * @example Expected data
 * {"nodeid":"N03100195","name":"ConnectionStatus","status":"disconnected","orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N03100190","sensor":"l-i","name":"SensorSample","value":22308,"units":"ml","time":1454982774750183,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N03100195","name":"ConnectionStatus","status":"connected","orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N01232ea5","sensor":"mt","name":"SensorSample","value":49,"units":"","time":2827051422,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"mqttClientType":"unode-v5","orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","nodeid":"N03100195","profileName":"863835021001958","configToken":"65ef9434","name":"LoginReq","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d","nodeId":"N03100195","time":1454982777413574,"protocolVersion":0,"netName":"310170200154401","swVerId":"66bbf45","assocChannel":"undefined","localIP":"10.61.215.182"}
 {"nodeid":"N03100190","sensor":"lIR-i","name":"SensorSample","value":15930,"units":"ml","time":1454982774750366,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N03100190","sensor":"vp","name":"SensorSample","value":119284,"units":"","time":1454982774750701,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N03100190","sensor":"mip","name":"SensorSample","value":328,"units":"","time":1454982774751007,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N03100190","sensor":"aip","name":"SensorSample","value":33,"units":"","time":1454982774751312,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N03100190","sensor":"mP","name":"SensorSample","value":38434,"units":"","time":1454982774761016,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N03100190","sensor":"aP","name":"SensorSample","value":1148,"units":"","time":1454982774770690,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N01232ea5","sensor":"l","name":"SensorSample","value":54000,"units":"ml","time":2827051605,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N01232ea5","sensor":"lIR","name":"SensorSample","value":53000,"units":"ml","time":2827051849,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N03100195","sensor":"bc","name":"SensorSample","value":59,"units":"","time":1454980573009094,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N01232ea5","sensor":"t","name":"SensorSample","value":5857,"units":"","time":2827052062,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N03100195","sensor":"bR","name":"SensorSample","value":0,"units":"","time":1454980573022583,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N01232ea5","sensor":"T","name":"SensorSample","value":32097,"units":"","time":2827058288,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N01232ea5","sensor":"v","name":"SensorSample","value":118840,"units":"","time":2827064483,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N03100195","sensor":"jt","name":"SensorSample","value":4736917541861203900,"units":"","time":1454982154170549,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N01232ea5","sensor":"vp","name":"SensorSample","value":119113,"units":"","time":2827064788,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N03100195","sensor":"lt","name":"SensorSample","value":100,"units":"","time":1454980574956054,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N01232ea5","sensor":"mi","name":"SensorSample","value":0,"units":"","time":2827070922,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"msg":"","nodeid":"N03100195","name":"DeviceAlarm","alarmType":"Assert","alarmSeverity":"Clear","orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N01232ea5","sensor":"mip","name":"SensorSample","value":0,"units":"","time":2827071228,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N01232ea5","sensor":"ai","name":"SensorSample","value":36,"units":"","time":2827077362,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"msg":"Flushing sensor: bR\r\n200323 sensor\/sensor.c:137 Flushing sensor: lt\r\n200327 ws\/wspush.c:385 Push socket connected\r\n","nodeid":"N03100195","name":"DeviceAlarm","alarmType":"StrangeReboot","alarmSeverity":"Clear","orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N01232ea5","sensor":"aip","name":"SensorSample","value":36,"units":"","time":2827077667,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"msg":"","nodeid":"N03100195","name":"DeviceAlarm","alarmType":"HWFail_EEPROM","alarmSeverity":"Clear","orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N01232ea5","sensor":"mw","name":"SensorSample","value":31339297850,"units":"","time":2827077972,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N01232ea5","sensor":"aw","name":"SensorSample","value":12482248925,"units":"","time":2827078277,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"msg":"","nodeid":"N03100195","name":"DeviceAlarm","alarmType":"HWFail_STUCK_RELAY","alarmSeverity":"Clear","orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N01232ea5","sensor":"mP","name":"SensorSample","value":1,"units":"","time":2827084503,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"msg":"","nodeid":"N03100195","name":"DeviceAlarm","alarmType":"HWFail_MMA8451","alarmSeverity":"Clear","orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N01232ea5","sensor":"aP","name":"SensorSample","value":2182,"units":"","time":2827090698,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"msg":"","nodeid":"N03100195","name":"DeviceAlarm","alarmType":"HWFail_NIGHTHAWK","alarmSeverity":"Clear","orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 {"nodeid":"N01232ea5","sensor":"mPF","name":"SensorSample","value":20132864,"units":"","time":2827096923,"orgid":"246c9cf0-cb9d-11e5-8702-8ff8737c586d","siteid":"9bc59770-cb9d-11e5-8702-8ff8737c586d"}
 */

var configManager = require('kea-config');
configManager.setup('./config');

var mqtt    = require('mqtt');

var notificationManager = require('./manager.js');

// TODO: Get dd broker from config
var subscriptions = configManager.get('notifications.subscriptions');

for(var i in subscriptions){
    var subscription = subscriptions[i];

    var mqttClient  = mqtt.connect(subscription.uri);

    /**
     * On connect subscribe to all topics
     */
    mqttClient.on('connect', function () {
        global.log.info('Connected to %s', subscription.uri);
        // TODO: Subscribe to alert topics
        //var supported_alerts = notification_manager.getSupportedAlerts();
        for(var j in subscription.topics)
            mqttClient.subscribe(subscription.topics[j]);
        global.log.info('Subscribed to %s', subscription.topics[j]);
        //mqttClient.publish('presence', 'Hello mqtt');
    });

    /**
     * On message, parse and forward to NM
     */
    mqttClient.on('message', onMessage);
}


/**
 * On message, parse and forward to NM
 * @param topic
 * @param message
 */
function onMessage(topic, message) {
    try{
        // message is Buffer
        var alert = JSON.parse(message.toString());
        global.log.info('New alert', JSON.stringify(alert));
        //
        if(topic!='/test/alert')
        {
            notificationManager.send(alert);
        }
        else
        {
            notificationManager.send(alert);// should be synchronized
            mqttClient.publish('/test/confirmation', JSON.stringify(alert));
        }
        //mqttClient.end();
    } catch(e){
        global.log.error('Error parsing message: %s', e.message, e);
    }
}