
machine:
  environment:
    DATA_SVC: circleci/data-service
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
  override:
    - if [[ -e ~/docker/data-service.tar ]]; then docker load -i ~/docker/data-service.tar; fi
    - docker build -t $DATA_SVC data_service/
    - mkdir -p ~/docker; docker save $DATA_SVC > ~/docker/data-service.tar
    - sudo pip install awscli

test:
  override:
    - docker run -t $DATA_SVC sh -c "cd /src/Farallones/data_service && make test"

deployment:
  hub:
    branch: master
    commands:
      - sudo /home/ubuntu/Farallones/data_service/deploy/install-certificate.sh
      - docker login -e farallones-build@sensity.com -u teamfarallones -p teamfarallones2015 https://54.201.195.237:443
      - docker tag $DATA_SVC 54.201.195.237:443/data-service
      - docker push 54.201.195.237:443/data-service
      - curl -k https://teamfarallones:teamfarallones2015@54.201.195.237:443/send?event=data-service-deployed || true
